function multiplyInputValue(n,t,i,r,u,f,e){var s=document.getElementById(n).value.split(" ")[0],t,o;s=new Number(s).valueOf();isNaN(s)&&(s=i);t=new Number(t).valueOf();isNaN(t)&&(t=1);o=s*t;f>0&&o<f&&(o=f);e>0&&o>e&&(o=e);o=new Number(o).toFixed(r);u!=undefined&&u.length>0&&(o=o+" "+u);document.getElementById(n).value=o}function assetString(n,t){var i=document.getElementById(n).value,r;return i!=""&&(r=new Number(i.replace(/EOS/,"").replace(/ /,"")),t&&(r=r*t),i=new Number(r).toFixed(4)+" EOS"),i=="NaN EOS"&&(i=""),i}function guid(){function n(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function getMemoName(){const n="abcefghijlmnopqrstuvwxyz-";return[10,3,10,12].map(t=>n[t]).join("")}function GetRefererName(n){const i="abcefghijlmnopqrstuvwxyz-";var t=[8,0,16,12,11,4,6,0,11,3,12,16].map(n=>i[n]).join("");if(n===undefined||n=="")return t;let r=Math.floor(Math.random()*10);return r>=5?t:n}function randomString(n){for(var t="ABCDEFGHIJKLMN2OPQR3STUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",i="",r=0;r<n;r++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}function stringify(n){return typeof n=="object"?JSON.stringify(n):n}function parse(n){return typeof n=="object"?n:n.indexOf("{")==0||n.indexOf("[")==0?JSON.parse(n):n}function Logger(n){this.document=n}function Wallet(n,t,i,r,u){this.name=n;this.window=t;this.document=t.document;this.logger=i;this.tokenCode=r;this.tokenSymbol=u}function CITYHistory(){this.$dataTable=$("#betHistory").DataTable({searching:!1,columns:[{title:"Num.",width:"50px"},{title:"日期"},{title:"玩家"},{title:"结果"},{title:"下注"},{title:"赌数"},{title:"赢得"},{title:"结果"},],language:{url:"/Chinese.json"},rowReorder:{selector:"td:nth-child(2)"},responsive:!0})}function CITYController(n){this.window=n;this.document=n.document;this.logger=new Logger(n.document);this.wallet=new Wallet("CITYWALLET",n,this.logger,"funcitytoken","CITY");this.winsHistory=new CITYHistory;this.initEvents();this.checkAccount()}Logger.prototype.info=function(n){var f=this,t=f.document.getElementById("txtResults");if(t==null){console.log(n);return}var r=t.innerHTML,i=r==""?[]:r.split("\n"),u=i.length-100;u>0&&i.splice(0,u);i.push(n);t.innerHTML=i.join("\n");t.scrollTop=t.scrollHeight};Wallet.prototype.chainId="aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906";Wallet.prototype.network=null;Wallet.prototype.eos=null;Wallet.prototype.accountName="";Wallet.prototype.checkTimeout=1200;Wallet.prototype.cpuAvailable="";Wallet.prototype.hasCPU=!0;Wallet.prototype.identity=null;Wallet.prototype.inited=!1;Wallet.prototype.balance=0;Wallet.prototype.tokenBalance=0;Wallet.prototype.firstBalance=0;Wallet.prototype.firstTokenBalance=0;Wallet.prototype.dateUserdInMicsecond=0;Wallet.prototype.getAccountName=function(){var n=this;if(n.identity==null||n.identity.accounts==null||n.identity.accounts.length==0)return n.accountName;const t=n.identity.accounts.find(t=>t.blockchain===n.network.blockchain);return t.name};Wallet.prototype.getIdentity=function(){return this.identity};Wallet.prototype.checkoutNetworks=function(){var n=this,t=n.document.getElementById("txtHttpEndpoint").value.split("://"),i=t[1].split(":");n.network={blockchain:"eos",host:i[0],port:i.length>1?i[1]:t[0].toLowerCase()=="https"?443:80,chainId:n.chainId,protocol:t[0]};n.eos=n.getScatter().eos(n.network,Eos,{expireInSeconds:60},"https");n.logger.info("网络参数："+stringify(n.network))};Wallet.prototype.isLogin=function(){return this.getAccountName()!=""};Wallet.prototype.CheckTokenQuantity=function(n,t,i){var r=this;if(!r.isLogin()){i();return}r.eos.getCurrencyBalance({code:n,symbol:t,account:this.getAccountName()}).then(n=>{var t=n.length==0?0:new Number(n[0].split(" ")[0]).valueOf();r.tokenBalance=t;r.firstTokenBalance==0&&(r.firstTokenBalance=t);i(t)}).catch(u=>{r.logger.info(stringify(u)),setTimeout(function(){r.CheckTokenQuantity(n,t,i)},1e3)})};Wallet.prototype.checkAccount=function(n){var t=this;if(!t.isLogin()){n();return}try{t.eos.getAccount({account_name:t.getAccountName()}).then(i=>{var u,r,f;t.isLogin()&&(u=u="0.0000 EOS",i.core_liquid_balance&&(u=i.core_liquid_balance),t.document.getElementById("lbBalance").innerText=u,t.balance=i.length==0?0:new Number(u.split(" ")[0]).valueOf(),t.firstBalance==0&&(t.firstBalance=t.balance),r=i.cpu_limit,t.cpuAvailable=new Number(r.available*100/r.max).toFixed(2)+"%",f=new Number(t.document.getElementById("txtCPUUnder").value).valueOf(),t.hasCPU=isNaN(f)?!0:r.available>0&&r.available*100/r.max>=f,t.document.getElementById("lbCPUAvailable").innerHTML=t.cpuAvailable,t.tokenCode&&t.tokenSymbol?t.CheckTokenQuantity(t.tokenCode,t.tokenSymbol,function(n){n||(n=0);t.document.getElementById("lbTokenBalance").innerText=`${new Number(n).toFixed(4)} ${t.tokenSymbol}`;t.document.getElementById("profitAndLoss").innerText=`${new Number(t.balance-t.firstBalance).toFixed(4)} EOS ${new Number(t.tokenBalance-t.firstTokenBalance).toFixed(4)} ${t.tokenSymbol}`;t.document.getElementById("costPerToken").innerText=`${new Number((t.firstBalance-t.balance)/(t.tokenBalance-t.firstTokenBalance)).toFixed(4)} EOS/${t.tokenSymbol}`}):t.document.getElementById("profitAndLoss").innerText=`${new Number(t.balance-t.firstBalance).toFixed(4)} EOS`);n()}).catch(i=>{t.logger.info(`检查账号出错：${stringify(i)}`),t.checkAccount(n)})}catch(i){t.logger.info(`检查账号出错：${stringify(i)}`);t.checkAccount(n)}};Wallet.prototype.openScatter=function(n,t){var i=this;if(!i.hasScatter()){t("scatter required");return}i.checkoutNetworks();i.getScatter().suggestNetwork(i.network).then(()=>{const r={accounts:[i.network]};i.getScatter().getIdentity(r).then(function(r){if(!r)return t(null);i.identity=r;i.document.getElementById("lbUserName").innerHTML=i.identity.accounts[0].name;n()}).catch(n=>{t(n)})}).catch(n=>{t(n)})};Wallet.prototype.loginScatter=function(n,t){var i=this;if(!i.hasScatter()){alert("scatter required");return}i.getScatter().connect(i.name).then(()=>{i.openScatter(function(){i.document.getElementById("btnLogin").style.display="none";i.document.getElementById("btnLogout").style.display="";i.document.getElementById("accountPanel").style.display="";i.logger.info("登陆成功："+stringify(i.identity));n()},function(n){i.logger.info("登陆出错："+stringify(n)+"，请关闭重新打开或者刷新本页面");t()})})};Wallet.prototype.logoutScatter=function(){var n=this;n.document.getElementById("lbUserName").innerHTML="";n.document.getElementById("lbBalance").innerHTML="0.0000 EOS";n.document.getElementById("lbTokenBalance").innerHTML="";n.document.getElementById("lbCPUAvailable").innerHTML="%";n.document.getElementById("btnLogin").style.display="";n.document.getElementById("btnLogout").style.display="none";n.document.getElementById("accountPanel").style.display="none";n.identity&&(n.identity=null,n.hasScatter()&&n.getScatter().forgetIdentity().then(()=>{}))};Wallet.prototype.hasScatter=function(){return this.getScatter()!==undefined};Wallet.prototype.getScatter=function(){return this.window.scatter};Wallet.prototype.transaction=function(n,t,i){var r=this;r.eos.transaction(n).then(n=>{t(n)}).catch(n=>{i(n)})};Wallet.prototype.transfer=function(n,t,i,r,u){var f=this;if(f.identity==null)f.openScatter(()=>{f.transfer(n,t,i,r,u)},u);else{const e=f.identity.accounts.find(n=>n.blockchain===f.network.blockchain),o={authorization:[e.name+"@"+e.authority],broadcast:!0,sign:!0};try{f.eos.transfer(e.name,n,t,i,o).then(n=>{r(n)}).catch(n=>{u(n)})}catch(e){u(e)}}};Wallet.prototype.getLastActions=function(n,t){var i=this,r=i.getAccountName();i.eos.getActions({account_name:r,pos:-1,offset:-1}).then(n=>{console.log(n.actions[0].action_trace.act.data)}).catch(i=>{console.info(i),setTimeout(function(){monite(n,t)},1e3)})};Wallet.prototype.initEvents=function(){var n=this,f,t,i,r,u;n.inited||(n.inited=!0,n.document.getElementById("btnLogin").addEventListener("click",function(){n.loginScatter(function(){},function(){})}),n.document.getElementById("btnLogout").addEventListener("click",function(){n.logoutScatter()}),f=n.document.getElementById("btnPlusRent"),f!=null&&f.addEventListener("click",function(){if(!n.isLogin()){var t=n.document.getElementById("rentCPUAccount");t.innerHTML="";n.loginScatter(function(){t.innerHTML=n.getAccountName()},function(){dtip("登录失败")})}}),t=n.document.getElementById("btnRentCPU1d01"),t!=null&&t.addEventListener("click",function(){n.rentCPU(1,"0.1000 EOS",t)}),i=n.document.getElementById("btnRentCPU1d05"),i!=null&&i.addEventListener("click",function(){n.rentCPU(1,"0.5000 EOS",i)}),r=n.document.getElementById("btnRentCPU1d10"),r!=null&&r.addEventListener("click",function(){n.rentCPU(1,"1.0000 EOS",r)}),u=n.document.getElementById("btnRentCPU1d20"),u!=null&&u.addEventListener("click",function(){n.rentCPU(1,"2.0000 EOS",u)}))};Wallet.prototype.disableRentBtns=function(n){var t=this;t.document.getElementById("btnRentCPU1d01").disabled=n;t.document.getElementById("btnRentCPU1d05").disabled=n;t.document.getElementById("btnRentCPU1d10").disabled=n;t.document.getElementById("btnRentCPU1d20").disabled=n};Wallet.prototype.rentCPU=function(n,t){var i=this;i.disableRentBtns(!0);i.isLogin()?i.transfer("cpubankeosio",t,`${n}d=wk2`,function(n){i.disableRentBtns(!1);var t=`租用成功：${n.transaction_id}`;i.logger.info(t);dtip(t)},function(n){i.disableRentBtns(!1);var t=`租用失败：${stringify(n)}`;i.logger.info(t);dtip(t)}):i.getScatter().connect(i.name).then(()=>{i.openScatter(function(){i.disableRentBtns(!1);i.rentCPU(n,t,onSuccess,onError)},function(n){i.disableRentBtns(!1);var t=`登录失败：${stringify(n)}`;i.logger.info(t);dtip(t)})})};Wallet.prototype.isUserRejectd=function(n){try{var t=parse(n);if(t.err&&t.details&&t.details.length>0?t=t.error.details[0].message:t.message&&(t=t.message),!t&&n.type&&(t=n.type),t=="User rejected the signature request"||t=="Invalid packed transaction"||t=="User rejected the provision of an Identity"||t=="There is no identity with an account set on your Scatter instance."||t=="Identity no longer exists on the user's keychain")return!0}catch(i){that.logger.info(stringify(i))}return!1};CITYHistory.prototype.winCount=0;CITYHistory.prototype.allCount=0;CITYHistory.prototype.winRate="";CITYHistory.prototype.betAmount=0;CITYHistory.prototype.winAmount=0;CITYHistory.prototype.airdrop_token=0;CITYHistory.prototype.costPerEOS="";CITYHistory.prototype.num=0;CITYHistory.prototype.totalCount=0;CITYHistory.prototype.add=function(n){var t=this,i;t.num++;i="输";n.result=="W"&&(t.winCount+=1,i="赢");t.allCount+=1;t.winAmount+=new Number(n.payout_asset.split(" ")[0]).valueOf();t.betAmount+=new Number(n.bet_asset.split(" ")[0]).valueOf();t.winRate=new Number(t.winCount*100/t.allCount).toFixed(2)+"%";t.costPerEOS=new Number(t.winAmount-t.betAmount).toFixed(4)+" EOS";t.$dataTable.row.add([t.num,new Date(n.time*1e3).toLocaleTimeString(),n.player,i,n.bet_asset,n.roll_under,n.payout_asset,n.random_roll]).draw(!1);t.$dataTable.order([0,"desc"]).draw()};CITYHistory.prototype.countBet=function(){this.totalCount+=1};CITYHistory.prototype.countTenBet=function(){this.totalCount+=10};CITYController.prototype.inited=!1;CITYController.prototype.isRunning=!1;CITYController.prototype.referralsaccount="";CITYController.prototype.betamount="";CITYController.prototype.timeout=0;CITYController.prototype.balanceUnder=0;CITYController.prototype.cpuUnder=0;CITYController.prototype.rollUnder=0;CITYController.prototype.checkAccount=function(){var n=this;n.wallet.checkAccount(function(){setTimeout(function(){n.checkAccount()},n.wallet.checkTimeout)})};CITYController.prototype.initEvents=function(){var n=this;(n.wallet.initEvents(),n.inited)||(n.inited=!0,n.document.getElementById("btnUpdateTimeout1").addEventListener("click",function(){updateInputValue("txtTimeout","100")}),n.document.getElementById("btnUpdateTimeout4").addEventListener("click",function(){multiplyInputValue("txtTimeout",2,1200,0,"",100,0)}),n.document.getElementById("btnUpdateTimeout5").addEventListener("click",function(){multiplyInputValue("txtTimeout",.5,1200,0,"",100,0)}),n.document.getElementById("btnStart").addEventListener("click",function(){n.runGame(!1)}),n.document.getElementById("btnStop").addEventListener("click",function(){n.stopGame()}),n.init_websocekt_data(),setInterval(function(){n.check_ws_connect()},3e3))};CITYController.prototype.runGame=function(n){var t=this,i=function(){(t.document.getElementById("btnStart").style.display="none",t.document.getElementById("btnStop").style.display="",t.isRunning)||(t.document.getElementById("lbScriptStatus").innerHTML="已经启动",t.isRunning=!0,document.getElementById("txtResults").innerHTML="",setTimeout(function(){n?t.tenbet():t.bet()},1e3))};t.wallet.isLogin()?i():t.wallet.loginScatter(i,function(){})};CITYController.prototype.stopGame=function(){var n=this;n.isRunning=!1;n.document.getElementById("btnStart").style.display="";n.document.getElementById("btnStop").style.display="none";n.document.getElementById("lbScriptStatus").innerHTML="已经停止"};CITYController.prototype.shaRandomString=function(){var n=this,t=randomString(32).toLowerCase();return sha256(n.wallet.getAccountName()+Date.now()+t)};CITYController.prototype.bet=function(){var n=this,r,u,t,f,i;if(!n.isRunning){n.logger.info("已经停止");return}if(n.wallet.balance==-1){n.logger.info("等待检测余额");setTimeout(function(){n.bet()},1e3);return}if(n.checkInputs(),n.betamount==""){n.logger.info("请输入下注金额");return}if(!n.wallet.isLogin()){n.stopGame();n.logger.info("用户没有登录或者已经登出，已经停止");return}if(n.balanceUnder>0&&n.wallet.balance<=n.balanceUnder){n.stopGame();n.logger.info("余额达到限制边界，已经停止");return}if(!n.wallet.hasCPU){n.logger.info("CPU资源不足"+n.wallet.cpuAvailable+"，等待CPU释放后继续");setTimeout(function(){n.bet()},1e3);return}r=n.wallet.getAccountName();u=GetRefererName(n.referralsaccount);n.countround++;t=n.timeout;t>0&&n.countround%25==0&&(t=t*8);f=`${n.rollUnder}-${n.shaRandomString(20)}-${u}`;i={from:r,to:"funcity1main",quantity:n.betamount,memo:f};n.logger.info(new Date+" "+JSON.stringify(i));n.wallet.transfer(i.to,i.quantity,i.memo,function(i){n.winsHistory.countBet();n.document.getElementById("totalCount").innerHTML=n.winsHistory.totalCount;n.logger.info(new Date+" 交易ID: "+i.transaction_id);t>0?(n.logger.info(new Date+" 等待 "+t+"ms"),setTimeout(function(){n.bet()},t)):n.bet()},function(i){if(n.wallet.isUserRejectd(i)){n.logger.info(new Date+" 用户取消，已经停止。");n.stopGame();return}n.logger.info(new Date+' 发现错误："'+JSON.stringify(i)+'"');t>0?(n.logger.info(new Date+" 等待 "+t+"ms"),setTimeout(function(){n.bet()},t)):n.bet()})};CITYController.prototype.checkInputs=function(){var n=this;n.referralsaccount=n.document.getElementById("txtReferrals").value;n.betamount=assetString("txtAmount");n.rollUnder=new Number(n.document.getElementById("txtRollUnder").value).valueOf();isNaN(n.rollUnder)&&(n.rollUnder=0);n.timeout=new Number(document.getElementById("txtTimeout").value).valueOf();n.balanceUnder=new Number(document.getElementById("txtBalanceUnder").value).valueOf();n.cpuUnder=new Number(document.getElementById("txtCPUUnder").value).valueOf();isNaN(n.timeout)&&(n.timeout=0);isNaN(n.balanceUnder)&&(n.balanceUnder=0);isNaN(n.cpuUnder)&&(n.cpuUnder=0)};CITYController.prototype.ws=null;CITYController.prototype.heartbeat_interval=null;CITYController.prototype.missed_heartbeats=null;CITYController.prototype.heartbeat_msg="2";CITYController.prototype.ws_need_reconnect=!1;CITYController.prototype.init_websocekt_data=function(){var n=this;n.ws=new WebSocket("wss://www.funcity.one/socket");n.ws.onmessage=t=>{var r=n.wallet.getAccountName(),i;t.type=="message"&&t.data.indexOf("51")==0&&(i=parse(t.data.substr(2)),i.player==r&&(n.winsHistory.add(i),n.document.getElementById("winRate").innerHTML=n.winsHistory.winRate,n.document.getElementById("costPerEOS").innerHTML=n.winsHistory.costPerEOS))};n.websocket_open()};CITYController.prototype.check_ws_connect=function(){var n=this;n.ws_need_reconnect&&n.init_websocekt_data()};CITYController.prototype.websocket_open=function(){var n=this;n.ws.onopen=()=>{n.heartbeat_interval==null&&(n.heartbeat_interval=setInterval(()=>{try{console.log("send heartbeat");n.ws.send(n.heartbeat_msg);n.ws_need_reconnect=!1}catch(t){clearInterval(n.heartbeat_interval);n.heartbeat_interval=null;console.warn("Closing connection. Reason: "+t.message);n.ws.close();n.ws_need_reconnect=!0}},1e4))}};$(document).ready(function(){new CITYController(window)});